<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assegna Tempi - Gestionale Memorial D'Aloja</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        // Uso la versione 11.6.1 come da dipendenze del Canvas
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcczLTu5JCCN_Jq1WQ9I7woJm1WH5ij2s",
            authDomain: "memorial-d-aloja-1a095.firebaseapp.com",
            projectId: "memorial-d-aloja-1a095",
            storageBucket: "memorial-d-aloja-1a095.firebasestorage.app",
            messagingSenderId: "199060155053",
            appId: "1:199060155053:web:75be10bef14a446bf6f424"
        };
        // ------------------------------------
        
        // --- Firebase Setup ---
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        // FIX: Forzato l'uso dell'ID di default per leggere i dati esistenti.
        window.appId = 'default-daloja-app-id';

        window.showModal = (title, message, isError = false) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const header = document.getElementById('modal-header');
            
            if (isError) {
                header.classList.remove('bg-blue-600', 'bg-emerald-600');
                header.classList.add('bg-red-600');
            } else {
                header.classList.remove('bg-red-600', 'bg-blue-600');
                header.classList.add('bg-emerald-600');
            }
            modal.classList.remove('hidden');
        };

        const initFirebase = async () => {
            try {
                setLogLevel('Debug');
                if (Object.keys(firebaseConfig).length === 0) {
                     showModal('Errore di Configurazione', 'La configurazione di Firebase non è disponibile.', true);
                     return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken).catch(() => signInAnonymously(window.auth));
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID Utente: ${window.userId}`;
                        window.startFirestoreListeners();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showModal('Errore di Inizializzazione', 'Impossibile connettersi a Firebase.', true);
            }
        };

        // --- Collections References ---
        window.getTeamsCollectionRef = () => collection(window.db, `artifacts/${window.appId}/teams`);
        window.getCrewsCollectionRef = () => collection(window.db, `artifacts/${window.appId}/crews`);
        window.getTimesCollectionRef = () => collection(window.db, `artifacts/${window.appId}/times`);

        // --- State Management ---
        window.teams = [];
        window.crews = [];
        window.times = {}; // Oggetto per lookup veloce: { crewId: 'mm:ss.d' }
        window.activeTab = 'group8';

        // --- Firestore Listeners ---
        window.startFirestoreListeners = () => {
            onSnapshot(window.getTeamsCollectionRef(), (snapshot) => {
                window.teams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderPage();
            });
            
            onSnapshot(window.getCrewsCollectionRef(), (snapshot) => {
                window.crews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderPage();
            });

            onSnapshot(window.getTimesCollectionRef(), (snapshot) => {
                window.times = {};
                snapshot.docs.forEach(doc => {
                    window.times[doc.id] = doc.data().time;
                });
                window.renderPage();
            });
        };

        // --- Rendering Logic ---
        window.renderPage = () => {
            const container = document.getElementById('content-container');
            if (!container) return;
            container.innerHTML = '';

            const teamsToRender = window.teams.filter(t => {
                if (window.activeTab === 'group8') return t.teamSize === 8;
                if (window.activeTab === 'group4') return t.teamSize === 4;
                return false;
            }).sort((a,b) => a.teamName.localeCompare(b.teamName));

            if (teamsToRender.length === 0) {
                container.innerHTML = `<div class="text-center py-12">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M17 19c-.2-.5-1-.9-1.9-.9-1.8 0-3.6.9-4.7 2.4"/><path d="M21 17c-.2-.5-1-.9-1.9-.9-1.8 0-3.6.9-4.7 2.4"/><path d="M15 5c0 3-2 5-5 5S5 8 5 5s2-5 5-5 5 2 5 5Z"/><path d="M20 10c0 3-2 5-5 5s-5-2-5-5 2-5 5-5 5 2 5 5Z"/></svg>
                    <p class="text-slate-500">Nessun team creato in questa categoria.</p>
                    <a href="crea_equipaggi.html" class="mt-4 inline-block text-blue-400 hover:text-blue-300 font-semibold">Crea Team</a>
                </div>`;
                return;
            }

            teamsToRender.forEach(team => {
                const teamCrews = window.crews.filter(c => c.parentTeamId === team.id);
                
                // --- NUOVO: Logica di ordinamento ---
                const sortOrder = { '8+': 1, '4-': 2, '2-': 3, '4x': 1, '2x': 2, '1x': 3 };
                teamCrews.sort((a, b) => {
                    const orderA = sortOrder[a.type] || 99;
                    const orderB = sortOrder[b.type] || 99;
                    if (orderA !== orderB) return orderA - orderB;
                    return a.name.localeCompare(b.name);
                });

                let genderColor, genderLetter;
                switch (team.genereTeam) {
                    case 'F': genderColor = 'bg-purple-500/20 text-purple-300'; genderLetter = 'F'; break;
                    case 'MIX': genderColor = 'bg-yellow-500/20 text-yellow-300'; genderLetter = 'M'; break;
                    default: genderColor = 'bg-blue-500/20 text-blue-300'; genderLetter = 'M'; break;
                }

                let lastCrewType = null;
                let crewsHtml = teamCrews.map(crew => {
                    const savedTime = window.times[crew.id] || '';
                    const inputId = `time-input-${crew.id}`;
                    
                    let separatorHtml = '';
                    if (lastCrewType && crew.type !== lastCrewType) {
                        separatorHtml = `<div class="pt-3 mt-3 border-t border-slate-700/50"></div>`;
                    }
                    lastCrewType = crew.type;
                    
                    return separatorHtml + `
                        <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_auto] gap-x-4 gap-y-2 items-center py-3">
                            <div class="flex flex-col min-w-0">
                                <span class="font-bold text-slate-200 truncate">${crew.name}</span>
                                <span class="text-xs text-slate-400 truncate">${crew.members.map(m => m.cognome).join(', ')}</span>
                            </div>
                            <input type="text" id="${inputId}" value="${savedTime}" placeholder="mm:ss.d"
                                   class="w-full md:w-36 p-2 rounded-lg bg-slate-800 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner text-center font-mono tracking-wider">
                            <button onclick="window.saveTime('${crew.id}', '${team.id}', '${inputId}')"
                                    class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-200">
                                Salva
                            </button>
                        </div>
                    `;
                }).join('');

                if(teamCrews.length === 0) {
                    crewsHtml = `<p class="text-slate-500 text-center py-4 text-sm">Nessun equipaggio definito per questo team. <a href="crea_equipaggi.html" class="text-blue-400 hover:text-blue-300">Componi equipaggi</a>.</p>`;
                }

                const teamCardHTML = `
                    <div class="bg-white/5 border border-white/10 rounded-2xl mb-6 card-enter">
                        <div class="flex items-center p-4 border-b border-white/10">
                             <span class="flex-shrink-0 w-8 h-8 rounded-full ${genderColor} text-lg font-bold flex items-center justify-center">${genderLetter}</span>
                             <h4 class="text-xl font-bold text-slate-100 ml-4">${team.teamName}</h4>
                        </div>
                        <div class="p-4 divide-y divide-slate-700/50">
                            ${crewsHtml.startsWith('<div class="pt-3') ? crewsHtml.substring(crewsHtml.indexOf('>') + 1) : crewsHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += teamCardHTML;
            });
        };
        
        // --- Actions ---
        window.switchTab = (tab) => {
            window.activeTab = tab;
            document.querySelectorAll('#tabs-container button').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('bg-slate-700/50', 'text-slate-300');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-slate-700/50', 'text-slate-300');
                }
            });
            window.renderPage();
        };

        window.saveTime = async (crewId, teamId, inputId) => {
            const input = document.getElementById(inputId);
            if (!input) return;
            const timeValue = input.value.trim();
            
            const regex = /^[0-5]\d:[0-5]\d\.\d$/;
            if (!regex.test(timeValue)) {
                showModal('Errore di Formato', 'Il formato del tempo non è valido. Usa mm:ss.d (es. 01:45.3)', true);
                input.focus();
                input.classList.add('border-red-500', 'animate-pulse');
                setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 2000);
                return;
            }
            
            try {
                const timeDocRef = doc(window.getTimesCollectionRef(), crewId);
                await setDoc(timeDocRef, {
                    time: timeValue,
                    parentTeamId: teamId,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showModal('Tempo Salvato', `Il tempo ${timeValue} è stato salvato con successo.`);
            } catch (error) {
                console.error("Errore nel salvataggio del tempo:", error);
                showModal('Errore di Salvataggio', 'Non è stato possibile salvare il tempo nel database.', true);
            }
        };

        window.onload = () => {
            initFirebase();
            window.switchTab('group8');
        };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; }
        .background-gradient { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); filter: blur(100px); z-index: -1; }
        .gradient-1 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(59, 130, 246, 0.4), transparent 70%); animation: pulse 10s infinite alternate; }
        .gradient-2 { width: 400px; height: 400px; background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent 70%); animation: pulse 12s infinite alternate-reverse; }
        @keyframes pulse { from { transform: scale(0.9) rotate(0deg); } to { transform: scale(1.2) rotate(20deg); } }
        .card-enter { animation: card-enter-animation 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes card-enter-animation { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        input.border-red-500 { border-color: #ef4444 !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center text-white p-4 antialiased">

    <div class="fixed top-0 left-0 w-full h-full -z-10">
        <div class="background-gradient gradient-1"></div>
        <div class="background-gradient gradient-2"></div>
    </div>

    <header class="w-full max-w-5xl mx-auto pt-8 pb-4 text-center relative">
        <h1 class="text-4xl md:text-5xl font-black tracking-tight text-slate-100 mb-2">GESTIONALE CLASSIFICHE</h1>
        <h2 class="text-xl md:text-2xl font-light text-blue-400 mb-6">MEMORIAL D'ALOJA</h2>
        <p id="user-id-display" class="text-xs text-slate-500 mb-4"></p>
        <a href="index.html" class="absolute top-4 left-4 md:top-8 md:left-8 bg-white/5 border border-white/10 rounded-full p-2 hover:bg-white/10 transition-colors" title="Torna alla Home">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><path d="m15 18-6-6 6-6"/></svg>
        </a>
    </header>

    <main class="w-full max-w-3xl mx-auto py-4">
        
        <h3 class="text-3xl font-semibold text-slate-100 mb-6">Assegna Tempi di Gara</h3>

        <!-- Tabs -->
        <div id="tabs-container" class="flex justify-center space-x-2 mb-8 p-1 bg-slate-800/60 rounded-xl">
            <button data-tab="group8" onclick="window.switchTab('group8')"
                    class="w-full font-semibold py-3 px-4 rounded-lg transition-colors duration-300">
                Gruppi da 8
            </button>
            <button data-tab="group4" onclick="window.switchTab('group4')"
                    class="w-full font-semibold py-3 px-4 rounded-lg transition-colors duration-300">
                Gruppi da 4
            </button>
        </div>

        <!-- Content -->
        <div id="content-container">
            <div class="text-center py-12">
                <p class="text-slate-500">Caricamento dati dal database...</p>
            </div>
        </div>
        
    </main>
    
    <!-- Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 rounded-xl max-w-sm w-full mx-4 overflow-hidden shadow-2xl">
            <div id="modal-header" class="p-3 text-white font-bold text-lg"><span id="modal-title"></span></div>
            <div class="p-6">
                <p id="modal-message" class="text-slate-200 mb-6"></p>
                <button onclick="document.getElementById('custom-modal').classList.add('hidden')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg">Chiudi</button>
            </div>
        </div>
    </div>

</body>
</html>

