<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crea Equipaggi - Gestionale Memorial D'Aloja</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        // Uso la versione 11.6.1 come da dipendenze del Canvas
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- TUA CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcczLTu5JCCN_Jq1WQ9I7woJm1WH5ij2s",
            authDomain: "memorial-d-aloja-1a095.firebaseapp.com",
            projectId: "memorial-d-aloja-1a095",
            storageBucket: "memorial-d-aloja-1a095.firebasestorage.app",
            messagingSenderId: "199060155053",
            appId: "1:199060155053:web:75be10bef14a446bf6f424"
        };
        // ------------------------------------
        
        // --- Firebase Setup ---
        
        // Globals for Firebase services and user data
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-daloja-app-id';

        // Custom Utility for handling modals instead of alert/confirm
        window.showModal = (title, message, isError = false) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const header = document.getElementById('modal-header');
            
            if (isError) {
                header.classList.remove('bg-blue-600', 'bg-emerald-600');
                header.classList.add('bg-red-600');
            } else {
                header.classList.remove('bg-red-600', 'bg-blue-600');
                header.classList.add('bg-emerald-600');
            }
            modal.classList.remove('hidden');
        };
        
        // NEW: Custom Confirm Modal
        window.showConfirmModal = (title, message, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            
            // Clone and replace to remove old event listeners, which is crucial
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                onConfirm(); // Execute the callback
            });

            document.getElementById('confirm-modal-cancel-btn').onclick = () => {
                modal.classList.add('hidden');
            };
            
            modal.classList.remove('hidden');
        };

        const initFirebase = async () => {
            try {
                setLogLevel('Debug');
                
                if (Object.keys(firebaseConfig).length === 0) {
                     showModal('Errore di Configurazione', 'La configurazione di Firebase non Ã¨ disponibile. I dati non saranno salvati.', true);
                     return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Authentication
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                let authSuccessful = false;
                
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        authSuccessful = true;
                    } catch (e) {
                        console.warn("Custom token fallito. Tentativo di Autenticazione Anonima. Errore:", e.code);
                    }
                }
                
                if (!authSuccessful) {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID Utente: ${window.userId}`;
                        window.startFirestoreListeners();
                    } else {
                        window.userId = 'anonymous';
                        document.getElementById('user-id-display').textContent = 'ID Utente: Anonimo';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showModal('Errore di Inizializzazione', 'Impossibile connettersi ai servizi Firebase.', true);
            }
        };

        // --- Firestore Utilities ---

        window.teams = [];
        window.crews = []; 
        window.selectedTeamId = null; 

        window.getTeamsCollectionRef = () => collection(window.db, `artifacts/${window.appId}/teams`);
        window.getCrewsCollectionRef = () => collection(window.db, `artifacts/${window.appId}/crews`);
        window.getTimesCollectionRef = () => collection(window.db, `artifacts/${window.appId}/times`);

        // --- State Management for Team Creation ---
        window.currentTeamName = '';
        window.currentTeamGenere = '';
        window.currentTeamSize = 8; // Default size
        window.currentAthletes = [];

        // NEW: Function to create sample data
        window.createSampleTeams = async () => {
            const sampleTeams = [
                {
                    teamName: "Canottieri Esempio",
                    genereTeam: "M",
                    teamSize: 8,
                    userId: window.userId || 'system-generated',
                    createdAt: serverTimestamp(),
                    athletes: [
                        { nome: "Marco", cognome: "Bianchi" }, { nome: "Luca", cognome: "Rossi" },
                        { nome: "Paolo", cognome: "Verdi" }, { nome: "Giorgio", cognome: "Neri" },
                        { nome: "Andrea", cognome: "Gialli" }, { nome: "Simone", cognome: "Blu" },
                        { nome: "Davide", cognome: "Viola" }, { nome: "Matteo", cognome: "Arancio" }
                    ]
                },
                {
                    teamName: "Voga Veneta",
                    genereTeam: "F",
                    teamSize: 4,
                    userId: window.userId || 'system-generated',
                    createdAt: serverTimestamp(),
                    athletes: [
                        { nome: "Giulia", cognome: "Rosa" }, { nome: "Sara", cognome: "Azzurri" },
                        { nome: "Laura", cognome: "Marroni" }, { nome: "Chiara", cognome: "Argento" }
                    ]
                }
            ];
            try {
                for (const team of sampleTeams) {
                    await addDoc(window.getTeamsCollectionRef(), team);
                }
                showModal('Dati di Esempio Creati', 'Sono stati aggiunti due team di esempio per iniziare. Ora puoi comporre i loro equipaggi o crearne di nuovi!');
            } catch (e) {
                console.error("Errore nella creazione dei team di esempio: ", e);
                showModal('Errore', 'Impossibile creare i team di esempio.', true);
            }
        };

        window.startFirestoreListeners = async () => {
            const teamsRef = window.getTeamsCollectionRef();
            // Check for sample data on initial load
            try {
                const initialTeamsSnapshot = await getDocs(teamsRef);
                if (initialTeamsSnapshot.empty) {
                    console.log("Database team vuoto. Creo dati di esempio.");
                    await window.createSampleTeams();
                }
            } catch (e) {
                console.error("Errore nel controllo dei team iniziali:", e);
            }

            onSnapshot(teamsRef, (snapshot) => {
                window.teams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.selectedTeamId && !window.teams.find(t => t.id === window.selectedTeamId)) {
                    window.selectedTeamId = null;
                }
                console.log("Teams aggiornati:", window.teams);
                window.renderTeamsList(); 
                window.renderCrewsList(window.selectedTeamId);
                window.checkFormValidity();
            });
            
            onSnapshot(window.getCrewsCollectionRef(), (snapshot) => {
                window.crews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Equipaggi aggiornati:", window.crews);
                window.renderTeamsList(); 
                window.renderCrewsList(window.selectedTeamId); 
            });
        };

        // --- Core Application Logic (Team Creation) ---

        window.checkFormValidity = () => {
            // Check team details first
            const teamNameInput = document.getElementById('teamNameInput');
            const isNameDuplicate = window.teams.some(team => team.teamName.toLowerCase() === window.currentTeamName.toLowerCase());
            
            let isTeamSectionValid = true;
            teamNameInput.classList.remove('border-red-500');
            if (!window.currentTeamName || !window.currentTeamGenere || !window.currentTeamSize) {
                isTeamSectionValid = false;
            }
            if (isNameDuplicate) {
                teamNameInput.classList.add('border-red-500');
                isTeamSectionValid = false;
            }

            // Enable/disable the athlete section based on team validity
            const athletesFormWrapper = document.getElementById('athletes-form-container-wrapper');
            if (isTeamSectionValid) {
                athletesFormWrapper.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                athletesFormWrapper.classList.add('opacity-50', 'pointer-events-none');
            }

            // Now, check athlete details
            const athleteRows = document.querySelectorAll('#athletes-form-container .athlete-row');
            const tempAthletes = [];
            let areAthletesValid = true;

            if (athleteRows.length !== window.currentTeamSize) {
                 areAthletesValid = false; 
            } else {
                const allNames = Array.from(athleteRows).map(row => row.querySelector('input[data-type="fullname"]').value.trim().toLowerCase());
                const nameCounts = allNames.reduce((acc, name) => { acc[name] = (acc[name] || 0) + 1; return acc; }, {});

                athleteRows.forEach(row => {
                    const fullNameInput = row.querySelector('input[data-type="fullname"]');
                    fullNameInput.classList.remove('border-red-500');
                    const fullName = fullNameInput.value.trim();
                    const fullNameLower = fullName.toLowerCase();
                    const parts = fullName.split(' ').filter(p => p);

                    if (parts.length < 2 || nameCounts[fullNameLower] > 1) {
                        areAthletesValid = false;
                        fullNameInput.classList.add('border-red-500');
                    }
                });

                if (areAthletesValid) {
                     athleteRows.forEach(row => {
                        const fullName = row.querySelector('input[data-type="fullname"]').value.trim();
                        const parts = fullName.split(' ').filter(p => p);
                        const cognome = parts.pop();
                        const nome = parts.join(' ');
                        tempAthletes.push({ nome, cognome });
                    });
                }
            }

            const isFormValid = isTeamSectionValid && areAthletesValid && (tempAthletes.length === window.currentTeamSize);

            window.currentAthletes = isFormValid ? tempAthletes : [];
            document.getElementById('save-team-button').disabled = !isFormValid;
            return isFormValid;
        };
        
        window.handleFormInput = () => {
            window.currentTeamName = document.getElementById('teamNameInput').value.trim();
            window.currentTeamGenere = document.getElementById('teamGenereInput').value;
            window.currentTeamSize = parseInt(document.getElementById('teamSizeInput').value, 10);
            
            const teamNameDisplay = document.getElementById('team-name-display');
            const isNameDuplicate = window.teams.some(team => team.teamName.toLowerCase() === window.currentTeamName.toLowerCase());
            
            if (isNameDuplicate) {
                teamNameDisplay.textContent = `Nome Team giÃ  esistente!`;
                teamNameDisplay.classList.add('text-red-400');
            } else {
                 teamNameDisplay.classList.remove('text-red-400');
                if (window.currentTeamName && window.currentTeamGenere) {
                    teamNameDisplay.textContent = `Atleti per: ${window.currentTeamName} (${window.currentTeamGenere})`;
                } else {
                    teamNameDisplay.textContent = `Completa i dati del Team`;
                }
            }
            
            const currentInputs = document.querySelectorAll('#athletes-form-container .athlete-row').length;
            if (currentInputs !== window.currentTeamSize) {
                window.renderAthleteInputForm(window.currentTeamSize);
            }

            window.checkFormValidity();
        };

        window.saveTeamAndAthletes = async () => {
            if (!window.checkFormValidity() || !window.db) {
                showModal('Attenzione', 'Controlla i campi in rosso. Assicurati che il nome del team non sia duplicato e che tutti i nomi e cognomi degli atleti siano inseriti e non ripetuti.', true);
                return;
            }

            try {
                const newTeamData = {
                    teamName: window.currentTeamName,
                    genereTeam: window.currentTeamGenere,
                    teamSize: window.currentTeamSize,
                    userId: window.userId,
                    createdAt: serverTimestamp(),
                    athletes: window.currentAthletes 
                };
                await addDoc(window.getTeamsCollectionRef(), newTeamData);

                showModal('Successo!', `Team "${window.currentTeamName}" salvato. Ora puoi definire gli equipaggi!`);
                
                document.getElementById('teamNameInput').value = '';
                document.getElementById('teamGenereInput').value = '';
                document.getElementById('teamSizeInput').value = '8';
                window.handleFormInput();
                
            } catch (e) {
                console.error("Errore salvataggio team: ", e);
                showModal('Errore di Salvataggio', 'Non Ã¨ stato possibile salvare il team.', true);
            }
        };
        
        window.saveCompetitionCrews = async (teamId) => {
            const team = window.teams.find(t => t.id === teamId);
            if (!team) return showModal('Errore', 'Dati del Team non trovati.', true);
            
            try {
                const crewsRef = window.getCrewsCollectionRef();
                const crewForms = document.querySelectorAll('.crew-form');
                const crewsToSave = [];
                let validationError = null;

                crewForms.forEach(form => {
                    const crewType = form.dataset.crewType;
                    const crewName = form.dataset.crewName;
                    const requiredMembers = parseInt(form.dataset.membersRequired, 10);
                    let members = [];

                    if (form.dataset.autoPopulated === 'true') {
                        const memberIndices = form.dataset.memberIds.split(',');
                        members = memberIndices.map(index => {
                           const athlete = team.athletes[parseInt(index, 10)];
                           return { nome: athlete.nome, cognome: athlete.cognome };
                        });
                    } else {
                         const memberSelectors = form.querySelectorAll('select[data-member-index]');
                         const selectedIds = new Set();
                         memberSelectors.forEach(select => {
                            if (select.value && select.value !== 'placeholder') {
                                const memberData = JSON.parse(select.value);
                                if(selectedIds.has(memberData.id)) validationError = `Atleta ${memberData.nome} ${memberData.cognome} duplicato in ${crewName}.`;
                                selectedIds.add(memberData.id);
                                members.push({ nome: memberData.nome, cognome: memberData.cognome });
                            }
                         });
                    }
                    
                    if (validationError) return;
                    if (members.length !== requiredMembers) validationError = `L'equipaggio ${crewName} richiede ${requiredMembers} atleti.`;
                    if (validationError) return;

                    crewsToSave.push({ parentTeamId: teamId, name: crewName, type: crewType, members, createdAt: serverTimestamp() });
                });
                
                if (validationError) return showModal('Attenzione', validationError, true);
                
                // Clear existing crews for this team before saving new ones
                const existingCrewsQuery = query(crewsRef, where("parentTeamId", "==", teamId));
                const existingCrewsSnapshot = await getDocs(existingCrewsQuery);
                for (const crewDoc of existingCrewsSnapshot.docs) {
                    await deleteDoc(doc(crewsRef, crewDoc.id));
                }

                for (const crew of crewsToSave) await addDoc(crewsRef, crew);

                showModal('Successo!', `Tutti gli equipaggi per il Team "${team.teamName}" sono stati salvati!`);
                window.switchPage('crea_equipaggi');
                
            } catch (e) {
                console.error("Errore nel salvare gli equipaggi: ", e);
                showModal('Errore di Salvataggio', 'Non Ã¨ stato possibile salvare gli equipaggi.', true);
            }
        };

        window.renderAthleteInputForm = (size = 8) => {
            const container = document.getElementById('athletes-form-container');
            if (!container) return;
            container.innerHTML = '';

            for (let i = 0; i < size; i++) {
                const row = document.createElement('div');
                row.className = 'athlete-row flex space-x-2 items-center mb-2';
                row.innerHTML = `
                    <span class="w-8 text-center text-slate-400 text-sm font-mono">${i + 1}.</span>
                    <input type="text" data-type="fullname" placeholder="Nome e Cognome" required oninput="window.checkFormValidity()"
                           class="flex-grow p-2 rounded-lg bg-slate-700/50 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner text-sm">
                `;
                container.appendChild(row);
            }
            window.checkFormValidity();
        };
        
        window.selectTeam = (teamId) => {
            window.selectedTeamId = (window.selectedTeamId === teamId) ? null : teamId;
            window.renderTeamsList(); 
            window.renderCrewsList(window.selectedTeamId);
        };

        window.renderTeamsList = () => {
            const listContainer = document.getElementById('teams-list-container');
            if (!listContainer) return;
            
            listContainer.innerHTML = '<h4 class="text-xl font-bold mb-4 text-slate-100">Team</h4>';

            const teams8 = window.teams.filter(t => t.teamSize === 8).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            const teams4 = window.teams.filter(t => t.teamSize === 4).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            const renderGroup = (title, group) => {
                if (group.length > 0) {
                    let groupHtml = `<h5 class="text-sm font-semibold text-blue-300 uppercase tracking-wider mb-2 mt-3">${title}</h5>`;
                    group.forEach(team => {
                        const teamCrews = window.crews.filter(crew => crew.parentTeamId === team.id);
                        
                        // Correct calculation for required crews for 4x
                        const totalCrewsRequired = team.teamSize === 8 ? 7 : (1 + 2 + team.athletes.length); // 4x, 2x A, 2x B, and 1x for each athlete

                        let actionButton = `<button onclick="event.stopPropagation(); window.startCrewComposition('${team.id}')" class="text-blue-400 hover:text-blue-300 text-xs font-semibold border border-blue-400 px-2 py-1 rounded-full">Componi</button>`;
                        if (teamCrews.length >= totalCrewsRequired) {
                            actionButton = `<span class="text-emerald-400 text-xs font-semibold px-2">COMPLETO</span>`;
                        }
                        
                        let genderColor, genderLetter;
                        switch (team.genereTeam) {
                            case 'F': genderColor = 'bg-purple-500/20 text-purple-300'; genderLetter = 'F'; break;
                            case 'MIX': genderColor = 'bg-yellow-500/20 text-yellow-300'; genderLetter = 'M'; break;
                            default: genderColor = 'bg-blue-500/20 text-blue-300'; genderLetter = 'M'; break;
                        }

                        const isSelected = window.selectedTeamId === team.id;
                        const selectionClass = isSelected ? 'border-blue-500 bg-blue-500/10' : 'border-white/10';

                        groupHtml += `
                        <div onclick="window.selectTeam('${team.id}')" class="flex justify-between items-center p-3 bg-white/5 ${selectionClass} rounded-lg mb-2 hover:bg-white/10 transition-all cursor-pointer">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full ${genderColor} text-sm font-bold flex items-center justify-center">${genderLetter}</span>
                                <p class="font-bold text-slate-100 truncate">${team.teamName}</p>
                            </div>
                            <div class="flex items-center space-x-2 ml-2 flex-shrink-0">
                                ${actionButton}
                                <button onclick="event.stopPropagation(); window.deleteTeam('${team.id}', '${team.teamName}')" class="text-red-400 hover:text-red-500 p-1" title="Elimina Team">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>`;
                    });
                    listContainer.innerHTML += groupHtml;
                }
            };

            renderGroup('Gruppo 8+', teams8);
            renderGroup('Gruppo 4x', teams4);

            if (window.teams.length === 0) {
                 listContainer.innerHTML += '<p class="text-slate-500 text-center py-4">Nessun team registrato.</p>';
            }
        };
        
        window.renderCrewsList = (teamId = null) => {
            const crewsContainer = document.getElementById('crews-list-container');
            if (!crewsContainer) return;
            
            if (!teamId) {
                crewsContainer.innerHTML = '<h4 class="text-xl font-bold mb-4 text-slate-100">Equipaggi</h4>';
                crewsContainer.innerHTML += '<p class="text-slate-500 text-center py-4">Seleziona un team per vedere i suoi equipaggi.</p>';
                return;
            }

            const parentTeam = window.teams.find(t => t.id === teamId);
            if (!parentTeam) {
                crewsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Team non trovato.</p>';
                return;
            }
            
            crewsContainer.innerHTML = `<h4 class="text-xl font-bold mb-4 text-slate-100">Equipaggi per: <span class="text-blue-300">${parentTeam.teamName}</span></h4>`;
            const filteredCrews = window.crews.filter(crew => crew.parentTeamId === teamId);

            if (filteredCrews.length === 0) {
                 crewsContainer.innerHTML += '<p class="text-slate-500 text-center py-4">Nessun equipaggio salvato per questo team.</p>';
                 return;
            }

            let crewsHtml = filteredCrews.map(crew => `
                <div class="flex justify-between items-center p-3 bg-slate-700/50 border border-slate-600 rounded-lg mb-2 text-sm">
                    <span class="font-bold text-slate-100">${crew.name}</span>
                    <span class="text-emerald-400 font-semibold ml-2 text-right">${crew.members.map(m => `${m.nome} ${m.cognome}`).join(', ')}</span>
                </div>
            `).join('');
            
            crewsContainer.innerHTML += crewsHtml;
        };

        window.deleteTeam = async (teamId, teamName) => {
            window.showConfirmModal(
                'Conferma Eliminazione',
                `Sei sicuro di voler eliminare il Team "${teamName}" e tutti i suoi equipaggi? L'azione Ã¨ irreversibile.`,
                async () => {
                    try {
                        const crewsRef = window.getCrewsCollectionRef();
                        const crewsToDeleteQuery = query(crewsRef, where("parentTeamId", "==", teamId));
                        const crewsSnapshot = await getDocs(crewsToDeleteQuery);
                        for (const crewDoc of crewsSnapshot.docs) {
                            await deleteDoc(doc(crewsRef, crewDoc.id));
                        }
                        await deleteDoc(doc(window.getTeamsCollectionRef(), teamId));
                        showModal('Eliminato', `Team "${teamName}" eliminato con successo.`);
                    } catch (error) {
                        console.error("Errore eliminazione: ", error);
                        showModal('Errore', 'Impossibile eliminare il team.', true);
                    }
                }
            );
        };

        window.currentCompositionAthletes = [];
        window.updateAthleteOptions = (category) => {
            const categorySelectors = document.querySelectorAll(`.crew-member-selector[data-crew-category="${category}"]`);
            const selectedIds = new Set();
            categorySelectors.forEach(sel => {
                if (sel.value !== 'placeholder') selectedIds.add(JSON.parse(sel.value).id);
            });

            categorySelectors.forEach(selector => {
                const currentId = selector.value !== 'placeholder' ? JSON.parse(selector.value).id : null;
                selector.innerHTML = `<option value="placeholder" disabled>-- Seleziona --</option>` + 
                    window.currentCompositionAthletes
                        .filter(a => !selectedIds.has(a.id) || a.id === currentId)
                        .map(a => `<option value='${JSON.stringify({ id: a.id, nome: a.nome, cognome: a.cognome })}'>${a.nome} ${a.cognome}</option>`)
                        .join('');
                if (currentId !== null) {
                    const currentAthlete = window.currentCompositionAthletes.find(a=>a.id===currentId);
                    if (currentAthlete) {
                        selector.value = JSON.stringify({ id: currentAthlete.id, nome: currentAthlete.nome, cognome: currentAthlete.cognome });
                    }
                } else {
                     selector.querySelector('option[value="placeholder"]').selected = true;
                }
            });
        };
        
        window.startCrewComposition = (teamId) => {
            const team = window.teams.find(t => t.id === teamId);
            if (!team) return showModal('Errore', 'Team non trovato.', true);
            
            window.currentCompositionAthletes = team.athletes.map((a, index) => ({...a, id: index}));

            const container = document.getElementById('crew-composition-container');
            let crewDefinitions, htmlContent = '';
            
            const athletesWithId = window.currentCompositionAthletes;
            const athleteOptions = athletesWithId.map(a => `<option value='${JSON.stringify({ id: a.id, nome: a.nome, cognome: a.cognome })}'>${a.nome} ${a.cognome}</option>`).join('');

            htmlContent = `<h4 class="text-2xl font-bold mb-6 text-slate-100">Componi Equipaggi per: <span class="text-blue-300">${team.teamName}</span></h4>
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">`;

            if (team.teamSize === 8) {
                crewDefinitions = [
                    { type: '8+', name: `${team.teamName} (8+)`, members: 8, color: 'text-blue-400', auto: true, autoMembers: athletesWithId.map(a=>a.id) },
                    { type: '4-', name: `${team.teamName} (4- A)`, members: 4, color: 'text-purple-400', cat: 'cat-4' },
                    { type: '4-', name: `${team.teamName} (4- B)`, members: 4, color: 'text-purple-400', cat: 'cat-4' },
                    { type: '2-', name: `${team.teamName} (2- A)`, members: 2, color: 'text-yellow-400', cat: 'cat-2' },
                    { type: '2-', name: `${team.teamName} (2- B)`, members: 2, color: 'text-yellow-400', cat: 'cat-2' },
                    { type: '2-', name: `${team.teamName} (2- C)`, members: 2, color: 'text-yellow-400', cat: 'cat-2' },
                    { type: '2-', name: `${team.teamName} (2- D)`, members: 2, color: 'text-yellow-400', cat: 'cat-2' },
                ];
            } else { // Team size 4
                crewDefinitions = [
                    { type: '4x', name: `${team.teamName} (4x)`, members: 4, color: 'text-blue-400', auto: true, autoMembers: athletesWithId.map(a=>a.id) },
                    { type: '2x', name: `${team.teamName} (2x A)`, members: 2, color: 'text-purple-400', cat: 'cat-2x' },
                    { type: '2x', name: `${team.teamName} (2x B)`, members: 2, color: 'text-purple-400', cat: 'cat-2x' },
                    ...athletesWithId.map((a, i) => ({ type: '1x', name: `${a.nome} ${a.cognome} (1x)`, members: 1, color: 'text-yellow-400', auto: true, autoMembers: [a.id] }))
                ];
            }
            
            crewDefinitions.forEach(crew => {
                htmlContent += `<div class="crew-form bg-white/5 border border-white/10 p-4 rounded-xl space-y-3 shadow-lg" 
                                     data-crew-type="${crew.type}" data-crew-name="${crew.name}" data-members-required="${crew.members}"
                                     ${crew.auto ? `data-auto-populated="true" data-member-ids="${crew.autoMembers.join(',')}"`:''}>
                                    <h5 class="text-lg font-semibold ${crew.color}">${crew.name}</h5>`;
                if (crew.auto) {
                    htmlContent += `<p class="text-xs text-slate-400">Compilato automaticamente.</p><div class="grid grid-cols-2 gap-x-4 text-sm pl-2">
                                    ${crew.autoMembers.map(id => athletesWithId.find(a=>a.id===id)).map(a => `<span class="text-slate-300 truncate">${a.nome} ${a.cognome}</span>`).join('')}
                                    </div>`;
                } else {
                    htmlContent += `<p class="text-xs text-slate-400">Seleziona ${crew.members} atleti.</p>`;
                    for (let i = 0; i < crew.members; i++) {
                         htmlContent += `<select data-member-index="${i}" onchange="window.updateAthleteOptions('${crew.cat}')" data-crew-category="${crew.cat}"
                                                 class="crew-member-selector w-full p-2 rounded-lg bg-slate-700/50 border border-slate-600 text-white text-sm">
                                            <option value="placeholder" selected disabled>-- Seleziona Atleta ${i+1} --</option>${athleteOptions}
                                         </select>`;
                    }
                }
                htmlContent += `</div>`;
            });
            
            htmlContent += `</div><div class="space-y-3">
                <button onclick="window.saveCompetitionCrews('${teamId}')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg">SALVA EQUIPAGGI</button>
                <button onclick="window.switchPage('crea_equipaggi')" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">ANNULLA</button>
                </div>`;
            
            container.innerHTML = htmlContent;
            window.switchPage('componi_equipaggi');
        };

        window.switchPage = (page) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(`${page}-page`);
            if(target) target.classList.remove('hidden');
        };

        window.onload = () => {
            initFirebase();
            window.switchPage('crea_equipaggi');
            window.handleFormInput();
            window.renderCrewsList();
        };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; }
        .background-gradient { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); filter: blur(100px); z-index: -1; }
        .gradient-1 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(59, 130, 246, 0.4), transparent 70%); animation: pulse 10s infinite alternate; }
        .gradient-2 { width: 400px; height: 400px; background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent 70%); animation: pulse 12s infinite alternate-reverse; }
        @keyframes pulse { from { transform: scale(0.9) rotate(0deg); } to { transform: scale(1.2) rotate(20deg); } }
        .card-enter { animation: card-enter-animation 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes card-enter-animation { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        input.border-red-500 { border-width: 2px !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center text-white p-4 antialiased">

    <!-- Background -->
    <div class="fixed top-0 left-0 w-full h-full -z-10">
        <div class="background-gradient gradient-1"></div>
        <div class="background-gradient gradient-2"></div>
    </div>

    <!-- Header -->
    <header class="w-full max-w-5xl mx-auto pt-8 pb-4 text-center relative">
        <h1 class="text-4xl md:text-5xl font-black tracking-tight text-slate-100 mb-2">GESTIONALE CLASSIFICHE</h1>
        <h2 class="text-xl md:text-2xl font-light text-blue-400 mb-6">MEMORIAL D'ALOJA</h2>
        <p id="user-id-display" class="text-xs text-slate-500 mb-4"></p>
        <a href="index.html" class="absolute top-4 left-4 md:top-8 md:left-8 bg-white/5 border border-white/10 rounded-full p-2 hover:bg-white/10" title="Torna alla Home">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><path d="m15 18-6-6 6-6"/></svg>
        </a>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="w-full max-w-5xl mx-auto py-4">
        
        <!-- CREA EQUIPAGGI PAGE -->
        <section id="crea_equipaggi-page" class="page-content w-full">
            <h3 class="text-3xl font-semibold text-slate-100 mb-8">Gestione Team e Formazioni</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Colonna 1: Form Creazione -->
                <div class="bg-white/5 border border-blue-400/20 rounded-2xl p-6 card-enter">
                    <h4 class="text-xl font-bold mb-4 text-blue-300">Crea un Nuovo Team</h4>
                    <form onsubmit="event.preventDefault();" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="sm:col-span-3">
                                <label for="teamNameInput" class="block text-sm font-medium text-slate-300 mb-1">Nome Team</label>
                                <input type="text" id="teamNameInput" placeholder="Esempio: Barca A" required oninput="window.handleFormInput()"
                                       class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="sm:col-span-1">
                                <label for="teamSizeInput" class="block text-sm font-medium text-slate-300 mb-1">Gruppo</label>
                                <select id="teamSizeInput" required onchange="window.handleFormInput()"
                                        class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="8">8 Atleti</option>
                                    <option value="4">4 Atleti</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="teamGenereInput" class="block text-sm font-medium text-slate-300 mb-1">Genere Team</label>
                                <select id="teamGenereInput" required onchange="window.handleFormInput()"
                                        class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-Seleziona-</option>
                                    <option value="M">Maschile (M)</option>
                                    <option value="F">Femminile (F)</option>
                                    <option value="MIX">Misto (MIX)</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    
                    <div id="athletes-form-container-wrapper" class="mt-6 opacity-50 pointer-events-none transition-opacity">
                        <h5 id="team-name-display" class="text-base font-semibold mb-3 text-slate-300">Completa i dati del Team</h5>
                        <div id="athletes-form-container" class="max-h-72 overflow-y-auto pr-2">
                             <p class="text-center text-slate-500 py-4">Caricamento...</p>
                        </div>
                        <button id="save-team-button" onclick="window.saveTeamAndAthletes()" disabled
                                class="w-full mt-4 bg-blue-600 disabled:bg-slate-700 disabled:text-slate-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                            SALVA TEAM
                        </button>
                    </div>
                </div>

                <!-- Colonna 2: Liste -->
                <div class="space-y-8">
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 card-enter" style="animation-delay: 0.2s;">
                        <div id="teams-list-container">
                             <h4 class="text-xl font-bold mb-4 text-slate-100">Team</h4>
                             <p class="text-slate-500 text-center py-4">Caricamento team dal database...</p>
                        </div>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 card-enter" style="animation-delay: 0.4s;">
                        <div id="crews-list-container"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- COMPONI EQUIPAGGI PAGE -->
        <section id="componi_equipaggi-page" class="page-content hidden w-full">
            <div id="crew-composition-container" class="bg-white/5 border border-white/10 rounded-2xl p-6"></div>
        </section>
        
    </main>
    
    <!-- Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 rounded-xl max-w-sm w-full mx-4 overflow-hidden shadow-2xl">
            <div id="modal-header" class="p-3 text-white font-bold text-lg"><span id="modal-title"></span></div>
            <div class="p-6">
                <p id="modal-message" class="text-slate-200 mb-6"></p>
                <button onclick="document.getElementById('custom-modal').classList.add('hidden')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 rounded-xl max-w-sm w-full mx-4 overflow-hidden shadow-2xl">
            <div id="confirm-modal-header" class="p-3 bg-red-800 text-white font-bold text-lg"><span id="confirm-modal-title"></span></div>
            <div class="p-6">
                <p id="confirm-modal-message" class="text-slate-200 mb-6"></p>
                <div class="flex justify-end space-x-4">
                     <button id="confirm-modal-cancel-btn" class="w-full sm:w-auto bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg">Annulla</button>
                     <button id="confirm-modal-confirm-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Conferma Elimina</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

